# Chapter 22. 가상키 편집증

## 1. 목표: 데이터 정돈하기

---

- 수열 중간에 숫자가 몇 개 빠지면 마음이 매우 불편해지는 사람들이 있다.
- 가상키 편집증 안티패턴을 사용하는 사람: 데이터베이스 기술에 대한 이해나 확신이 부족

## 2. 안티패턴: 모든 틈 메우기

---

- 틈을 발견했을 때 대다수 사람들의 반응은 틈을 메우고 싶어 한다.

### 시퀀스에서 벗어난 번호 할당하기

---

- 새로운 행에 키 값을 할당할 때, 가상키 자동 생성 메커니즘을 사용하는 대신 PK 값 중 사용되지 않은 첫 번째 값을 사용하고 싶을 수 있다.
    - 😰 그러나 사용되지 않은 가장 작은 값을 찾으려면 불필요한 셀프조인을 실행해야 한다
        
        ```sql
        SELECT b1.bug_id + 1
          FROM Bugs b1
          LEFT OUTER JOIN Bugs AS b2 ON (b1.bug_id + 1 = b2.bug_id)
         WHERE b2.bug_id IS NULL
         ORDER BY b1.bug_id LIMIT 1;
        ```
        
    
    → 동시성 문제가 있음
    

### 기존 행의 번호를 다시 매기기

---

- PK 값이 가장 큰 행을 찾아 사용되지 않은 가장 작은 키 값으로 업데이트하는 방법
    - 😰 동시성 문제가 있음
        
        ```sql
        UPDATE Bugs
           SET bug_id = 3
         WHERE bug_id = 4;
        ```
        
        - 사용되지 않은 키 값을 찾아야 한다.
        - PK 값을 재할당하기 위해 `UPDATE` 문을 실행해야 한다.
    - 😰 번호를 새로 붙인 행을 참조하는 모든 자식 행에 변경된 키 값을 전파해야 한다.
        - `ON UPDATE CASCADE` 옵션을 사용해 외래키를 선언했다면 이 작업이 쉽겠지만, 그렇지 않다면 제약조건을 비활성화한 다음 모든 자식 행을 수작업으로 업데이트하고 제약조건을 복원해야 한다.
    - 😰 이런 정리 작업을 마쳤다 하더라도, 결과는 일시적일 뿐이다.
        - 새로운 가상키 값을 생성하면, 그 값은 현재 테이블에서 가장 큰 값이 아니라, 가장 최근에 생성했던 값보다 큰 값이 된다.

### 데이터 불일치 만들기

---

- PK 값을 재사용하는 것은 좋은 생각이 아니다.
    - 적절한 이유로 행을 삭제했거나 롤백한 결과로 틈이 발생한 것일 수 있기 때문이다.
    
    ❗가상키 값에 빈 값이 있다고 키를 재할당하면 안 된다.
    

## 3. 안티패턴 인식 방법

---

- “`INSERT`를 롤백했을 때 자동 생성된 아이디 값을 어떻게 재사용할 수 있지?”
    
    → 가상키 할당은 롤백되지 않는다. DBMS 는 가상키 값을 트랜잭션 범위 안에서 할당해야 할 것이다. 동시에 데이터를 삽입하려 하는 경우 경합 또는 대기가 발생한다.
    
- “bug_id 4에 무슨 일이 일어난 거지?”
    
    → PK 의 시퀀스에 사용되지 않은 번호에 대한 엉뚱한 걱정의 표현이다.
    
- “사용되지 않은 첫 번째 아이디 값을 어떻게 조회할 수 있을까?”
    
    → 이런 검색을 하려는 이유는 아이디 값을 재할당하려는 것
    
- “번호가 넘치면 어떻게 되지?”
    
    → 사용되지 않은 아이디 값을 재할당하는 것을 합리화하려 할 때 사용되는 표현
    

## 4. 안티패턴 사용이 합당한 경우

---

- 가상키 값을 바꿔야 할 이유는 없다.
    - 가상키 값은 아무런 의미도 가지지 말아야 하기 때문이다.
    - PK 칼럼의 값이 어떤 의미를 가진다면 그건 자연키(natural key)지 가상키가 아니다.

## 5. 해법: 극복하라

---

- PK 값은 유일하고 `NULL`이 아니어서 각 행을 참조하는 데 사용할 수 있어야 한다.
- 행을 식별하는 데 연속적인 숫자일 필요는 없다.

### 행에 번호 매기기

---

- PK 는 한 테이블에서 한 행을 식별하지만, 행 번호는 결과 집합에서 행을 식별하는 것이다.
    - 행 번호를 사용하면 좋은 경우: 쿼리 결과의 부분집합만 리턴하는 경우 (페이지 처리)
- `ROW_NUMBER()`: 쿼리 결과 집합에 대한 연속된 번호를 리턴한다. 쿼리 결과에서 행의 범위를 제한할 때 행 번호가 흔히 쓰인다.
    
    ```sql
    SELECT t1.*
      FROM (SELECT a.account_name, b.bug_id, b.summary, ROW_NUMBER() OVER (ORDER BY a.account_name, b.date_reported) AS rn
              FROM Accounts a JOIN Bugs b ON (a.account_id = b.reported_by)) AS t1
     WHERE t1.rn BETWEEN 1 AND 50;
    +--------------+--------+---------+----+
    | account_name | bug_id | summary | rn |
    +--------------+--------+---------+----+
    | account2     |      6 | NULL    |  1 |
    | account2     |      5 | NULL    |  2 |
    | account2     |      4 | NULL    |  3 |
    | account2     |      3 | NULL    |  4 |
    | account2     |      2 | NULL    |  5 |
    | account2     |      1 | NULL    |  6 |
    | account2     |    123 | NULL    |  7 |
    | account2     |   1234 | NULL    |  8 |
    +--------------+--------+---------+----+
    ```
    
    - MySQL과 SQLite는 `LIMIT` 절을 지원한다.

### GUID 사용하기

---

- GUID (Global Unique Identifier): 어떤 수를 한 번 이상 사용하지 않으면서 랜덤한 가상키 값을 생성
    - 128비트 의사난수로 보통 32자리 16진수로 표현된다.
    - ex> Microsoft SQL Server 2005 에서 GUID
        
        ```sql
        CREATE TABLE Bugs (
          bug_id UNIQUEIDENTIFIER DEFAULT NEWID(),
          -- . . .
        );
        
        INSERT INTO Bugs (bug_id, summary)
        VALUES (DEFAULT, 'crashes when I save');
        ```
        
    - 😃 일반적인 가상키 생성기를 사용할 때보다 좋은점
        - 중복을 걱정하지 않고 여러 데이터베이스 서버에서 동시에 가상키를 생성할 수 있다.
        - 아무도 틈에 대해 불평하지 않는다. PK 값으로 16진수를 32자리나 입력해야 하는 것을 불평하느라 바쁠 것이기 때문이다.
    - 😰 나쁜 점
        - 값이 너무 길고 입력하기 나쁘다.
        - 값이 랜덤하기 때문에, 어떤 패턴을 추론할 수 없고 큰 값이 최근 행을 나타낸다고 생각할 수도 없다.
        - GUID 를 저장하는 데는 16바이트가 필요하다. 일반적인 4바이트 정수 가상키를 사용하는 것보다 공간도 많이 차지하고 속도도 느리다.

### 가장 중요한 문제

---

- 가상키 값 사이의 틈을 메워 데이터베이스를 정리하길 바라는 상사의 지시 → 커뮤니케이션 문제
    - 기술을 설명하기
    - 비용을 명확하게 하기
        - 대부분의 관리자는 작업의 비용에 따라 우선순위를 매기며, 실제 비용과 직면하면 중요하지 않은 세세한 최적화 요청은 철회할 것이다.
    - 자연키 사용하기
        - PK 값에서 의미를 찾으려 한다면, PK 값이 의미를 가지게 한다.
        - 가상키를 사용하지 말고, 어떤 의미를 식별할 수 있는 문자열이나 숫자를 사용한다.

<aside>
💡 가상키를 행의 식별자로 사용한다. 가상키는 행 번호가 아니다.

</aside>

- 참고
    - [https://github.com/pravusid/TIL/blob/2636a636c1b43ba44199e68914c4c674cb172814/Database/sql-anti-patterns.md](https://github.com/pravusid/TIL/blob/2636a636c1b43ba44199e68914c4c674cb172814/Database/sql-anti-patterns.md)
    - [http://wiki.gurubee.net/pages/viewpage.action?pageId=16482310](http://wiki.gurubee.net/pages/viewpage.action?pageId=16482310)